# Part 4 真实SFT场景更新说明

## 🎯 更新目标

基于用户反馈："**流程还不够全面！我需要的是真实的SFT场景**"，我们对Part 4进行了重大更新，添加了大量真实的、实际的SFT调试场景。

## ✨ 核心更新

### 📌 从"理想化教程"到"真实项目实践"

之前：提供训练代码 + 说明文档  
现在：展示完整的迭代过程 + 问题发现 + 调试修复

---

## 📂 4.1 垂直领域SFT（中医问诊助手）

### 新增文件

| 文件 | 作用 | 真实场景 |
|------|------|----------|
| `data/data_filtering_pipeline.py` | **5轮数据筛选流程** | • 第1-3轮：规则、术语、AI打分<br>• 发现问题：高分数据仍有问题！<br>• 第4轮：回溯修正，添加新规则<br>• 第5轮：人工复核 |
| `training/problem_diagnosis_and_fix.py` | **5大问题诊断** | 1. 模型复读（数据重复+参数未设置）<br>2. 知识缺失（数据分布90%是一个证型）<br>3. 格式不一致（多种格式混杂）<br>4. 过度保守（只说"建议就医"）<br>5. 忽视输入（所有症状都诊断为同一个） |
| `ITERATION_LOG.md` | **7天完整记录** | • v0.1：完全失败（所有输出都是免责声明）<br>• v0.2：严重复读（同一句话重复3次）<br>• v0.3：判断错误（90%都诊断为"脾肾阳虚"）<br>• v1.0：基本可用（准确率85%）<br>• v1.1：效果优秀（准确率92%） |

### 真实案例示例

#### 案例1：数据筛选的回溯修正
```
第一遍：用规则匹配筛选 ✅
第二遍：用AI模型打分 ✅  
发现问题：高分数据中发现方剂剂量不合理！❌
回溯修正：添加剂量检查规则，重新筛选所有数据 🔄
```

#### 案例2：模型复读问题
```
现象：同一句话重复3次
诊断：
  1. 数据中有重复（26%的数据包含重复句子）
  2. 解码参数未设置repetition_penalty
解决：
  1. 数据去重
  2. 设置repetition_penalty=1.2
  3. 重新训练
```

#### 案例3：专业知识缺失
```
测试：输入"脾气大、容易发怒、胸胁胀痛"
期望：肝郁气滞
实际：脾肾阳虚 ❌

分析：训练数据中90%都是"脾肾阳虚"

解决方案：
  1. 数据诊断：发现严重不平衡
  2. 重新采样：每个证型至少50条
  3. 生成对比数据：区分相似症状
  4. 重新训练：使用balanced采样
```

---

## 📂 4.2 通用SFT（多任务对话助手）

### 新增文件

| 文件 | 作用 | 多任务特色 |
|------|------|-----------|
| `data/data_filtering_multitask.py` | **多任务数据平衡** | • 任务分布统计（600条 vs 50条）<br>• 上采样+下采样平衡<br>• 发现任务冲突（代码 vs 创意）<br>• 解决冲突（任务标签+强化提示） |
| `training/multitask_problems_diagnosis.py` | **多任务特有问题** | 1. 任务性能不均（翻译38% vs 问答85%）<br>2. **任务串扰**（翻译变问答）<br>3. 格式混乱（代码混入Markdown）<br>4. 能力遗忘（过度任务化）<br>5. 任务过拟合 |
| `MULTITASK_ITERATION_LOG.md` | **15天迭代记录** | • v0.1：性能严重不均<br>• v0.2：串扰加剧（平衡后更乱！）<br>• v0.3：强化任务边界<br>• v1.0：分阶段训练策略<br>• v1.1：效果优秀（平均85%） |

### 真实案例示例

#### 案例1：任务性能不均
```
v0.1测试结果：
  问答：85% ✅（数据600条）
  代码：80% ✅（数据500条）
  翻译：38% ❌（数据50条）

相差47%！

解决：上采样+下采样，每个任务100-150条
结果：翻译 38% → 62%
```

#### 案例2：任务串扰（多任务特有！）
```
任务：翻译"I love AI"
期望：我爱人工智能
实际：AI是一种计算机技术，它能够...（开始回答问答题！）

原因：问答任务"污染"了翻译任务

解决方案：
  1. 添加任务标签：[任务: 翻译] 只翻译，不要解释
  2. 强化约束：instruction中明确说明行为要求
  3. 分阶段训练：混合→分组→困难任务
```

#### 案例3：数据平衡后串扰加剧
```
v0.2问题：平衡数据后，任务串扰反而更严重！

表现：
  • 问答时列举多个答案（被头脑风暴影响）
  • 代码时反问用户（被对话任务影响）
  • 翻译时过度解释（被观点分析影响）

根本原因：不同任务对模型行为的要求是矛盾的！
  • 头脑风暴要求："多个选项是好的"
  • 问答任务要求："唯一答案是好的"
  • 这两个要求是矛盾的！
```

---

## 🆚 单任务 vs 多任务对比

| 维度 | 4.1 单任务（中医） | 4.2 多任务（通用） |
|------|------------------|------------------|
| **主要挑战** | 数据质量、专业深度 | 任务平衡、任务串扰 |
| **数据量** | 150-200条 | 1500-2000条 |
| **迭代周期** | 7天 | 15天 |
| **核心问题** | 复读、知识缺失、格式不一致 | 任务串扰、性能不均、能力遗忘 |
| **复杂度** | 基础 | 基础 × 10倍 |
| **特有问题** | 无 | **任务串扰**（单任务不会遇到） |

---

## 💡 核心经验总结

### 4.1 单任务的关键教训

1. **SFT是迭代过程**
   - 不是"收集数据→训练→完成"
   - 而是"数据→训练→测试→发现问题→修正数据→重新训练→..."
   - v0.1到v1.1经历了5次迭代

2. **数据质量 > 数据数量**
   - v0.1: 150条低质量 = 失败
   - v1.1: 158条高质量 = 成功

3. **不要盲目相信Loss**
   - Loss 0.89: 看起来很好，实际完全无用
   - Loss 1.2: 看起来一般，实际效果优秀

4. **发现问题要勇于回溯**
   - 第3轮AI打分后发现高分数据仍有问题
   - 不要将就，回到第1步重新筛选

### 4.2 多任务的关键教训

1. **任务平衡是艺术，不是数学**
   - 不是简单的"每个任务100条"
   - 需要平衡：数量、质量、难度、重要性

2. **任务串扰是多任务的魔鬼**
   - 这是单任务不会遇到的问题
   - 翻译变问答、代码变头脑风暴
   - 需要强化任务边界、添加负样本

3. **数据平衡可能加剧问题**
   - v0.2平衡数据后，串扰反而更严重
   - 因为"错误的模式"被强化了

4. **分阶段训练很有效**
   - 第1阶段：混合训练（学通用能力）
   - 第2阶段：分组训练（学任务特异性）
   - 第3阶段：困难任务强化

---

## 📊 更新成果

### 代码文件
- 新增：6个Python脚本（3个数据筛选 + 3个问题诊断）
- 更新：2个README（4.1和4.2）
- 新增：2个完整迭代日志（22天开发记录）

### 网页展示
- 更新：`Part4.vue`
- 新增：4.1真实场景展示区（橙色高亮）
- 新增：4.2真实场景展示区（紫色高亮）
- 新增：对比说明（单任务 vs 多任务）

### 文档价值
- **真实性**：不是理想化的教程，而是真实会遇到的问题
- **完整性**：从失败到成功的完整过程
- **实用性**：每个问题都有详细的解决方案
- **对比性**：单任务vs多任务的差异清晰

---

## 🎓 学习路径建议

### 初学者路径
1. 先阅读`Part4.vue`网页，了解整体概念
2. 运行`4.1/data/data_filtering_pipeline.py`，体验数据筛选
3. 运行`4.1/training/problem_diagnosis_and_fix.py`，了解典型问题
4. 阅读`4.1/ITERATION_LOG.md`，学习完整迭代过程
5. 根据理解，尝试实际训练

### 进阶路径
1. 完成4.1单任务项目
2. 理解单任务的挑战和解决方案
3. 进入4.2多任务项目
4. 对比单任务，理解多任务的额外挑战
5. 体验任务串扰、分阶段训练等高级技术

---

## 🔑 关键价值

### 为什么这些真实场景重要？

1. **避免重复踩坑**
   - 看到v0.1的失败，可以避免犯同样的错误
   - 了解问题的根本原因，而不只是表面现象

2. **建立正确预期**
   - SFT不是一次性工程，需要多次迭代
   - 第一版失败是正常的，不要灰心

3. **学习问题诊断**
   - 模型复读 → 检查数据重复和解码参数
   - 知识缺失 → 检查数据分布
   - 任务串扰 → 强化任务边界

4. **掌握调试技能**
   - 如何定位问题
   - 如何制定解决方案
   - 如何验证修复效果

---

## ✅ 总结

这次更新的核心价值：

> **从"如何训练"到"如何调试"**
> 
> 从"理想化的步骤"到"真实的迭代过程"
> 
> 从"提供代码"到"传授经验"

真实的SFT项目，90%的时间都在调试、迭代、优化。  
只有10%的时间在写训练代码。

**这次更新，就是要把那90%的真实过程展示出来！**

---

## 📞 使用方式

### 体验真实场景

```bash
# 4.1 单任务场景
cd sft-theory/code/part4/4.1_vertical_domain_tcm/

# 场景1：数据筛选迭代
python data/data_filtering_pipeline.py

# 场景2：问题诊断修复
python training/problem_diagnosis_and_fix.py

# 场景3：查看完整日志
cat ITERATION_LOG.md


# 4.2 多任务场景
cd sft-theory/code/part4/4.2_general_assistant/

# 场景1：多任务数据平衡
python data/data_filtering_multitask.py

# 场景2：多任务问题诊断
python training/multitask_problems_diagnosis.py

# 场景3：查看完整日志
cat MULTITASK_ITERATION_LOG.md
```

### 查看网页展示

```bash
# 启动项目
cd sft-theory/
bash start.sh

# 浏览器访问
http://localhost:3000

# 进入Part 4页面，查看：
# - 4.1的真实场景展示（橙色区域）
# - 4.2的真实场景展示（紫色区域）
```

---

**💡 记住：真实的SFT项目，是在不断试错中前进的！**

