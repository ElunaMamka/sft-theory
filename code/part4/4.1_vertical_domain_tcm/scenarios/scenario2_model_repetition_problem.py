"""
åœºæ™¯2ï¼šæ¨¡å‹å¤è¯»é—®é¢˜çš„å®Œæ•´è¯Šæ–­ä¸ä¿®å¤
=====================================

è¿™æ˜¯ä¸€ä¸ªçœŸå®çš„æ¨¡å‹è°ƒè¯•æ¡ˆä¾‹ï¼Œå±•ç¤ºäº†ï¼š
- è®­ç»ƒåå‘ç°æ¨¡å‹ä¸¥é‡å¤è¯»
- å¦‚ä½•ä¸€æ­¥æ­¥è¯Šæ–­æ ¹æœ¬åŸå› 
- å¤šç§è§£å†³æ–¹æ¡ˆçš„å¯¹æ¯”
- ä¿®å¤éªŒè¯è¿‡ç¨‹

è¿è¡Œæ—¶é—´ï¼šçº¦8åˆ†é’Ÿ
è¾“å‡ºï¼šå®Œæ•´çš„é—®é¢˜è¯Šæ–­ã€ä¿®å¤æ–¹æ¡ˆå’Œå¯¹æ¯”æµ‹è¯•
"""

import re
from typing import List, Dict
import time


class RepetitionProblemCase:
    """
    çœŸå®æ¡ˆä¾‹ï¼šæ¨¡å‹å¤è¯»é—®é¢˜çš„è¯Šæ–­ä¸ä¿®å¤
    """
    
    def __init__(self):
        self.test_cases = []
        self.diagnosis_results = {}
        
    def run(self):
        """è¿è¡Œå®Œæ•´çš„åœºæ™¯æ¼”ç¤º"""
        print("="*100)
        print(" "*25 + "åœºæ™¯2ï¼šæ¨¡å‹å¤è¯»é—®é¢˜ - å®Œæ•´è¯Šæ–­ä¸ä¿®å¤æµç¨‹")
        print("="*100)
        
        self.show_introduction()
        input("\n>>> æŒ‰Enteré”®å¼€å§‹...")
        
        # é˜¶æ®µ1ï¼šé—®é¢˜å‘ç°
        self.stage1_problem_discovery()
        input("\n>>> æŒ‰Enteré”®è¿›è¡Œè¯Šæ–­...")
        
        # é˜¶æ®µ2ï¼šåŸå› è¯Šæ–­
        self.stage2_root_cause_analysis()
        input("\n>>> æŒ‰Enteré”®æŸ¥çœ‹è§£å†³æ–¹æ¡ˆ...")
        
        # é˜¶æ®µ3ï¼šè§£å†³æ–¹æ¡ˆ
        self.stage3_solutions()
        input("\n>>> æŒ‰Enteré”®éªŒè¯ä¿®å¤æ•ˆæœ...")
        
        # é˜¶æ®µ4ï¼šä¿®å¤éªŒè¯
        self.stage4_verification()
        
        # é˜¶æ®µ5ï¼šæ€»ç»“
        self.stage5_summary()
    
    def show_introduction(self):
        """å±•ç¤ºåœºæ™¯ä»‹ç»"""
        print("\nğŸ“– åœºæ™¯èƒŒæ™¯ï¼š")
        print("-" * 100)
        print("""
ä½ å®Œæˆäº†æ•°æ®ç­›é€‰å’Œè®­ç»ƒï¼Œç°åœ¨æ¿€åŠ¨åœ°æµ‹è¯•ä½ çš„ä¸­åŒ»é—®è¯Šæ¨¡å‹...

è®­ç»ƒé…ç½®ï¼š
  - æ¨¡å‹ï¼šBaichuan2-7B
  - æ–¹æ³•ï¼šLoRA (r=8, alpha=16)
  - æ•°æ®ï¼š150æ¡é«˜è´¨é‡ä¸­åŒ»é—®è¯Šæ•°æ®
  - è®­ç»ƒï¼š3 epochs, lr=2e-4
  - Lossï¼šä»2.1é™åˆ°0.89ï¼ˆçœ‹èµ·æ¥å¾ˆå¥½ï¼ï¼‰

ä½ æ»¡æ€€æœŸå¾…åœ°è¾“å…¥ç¬¬ä¸€ä¸ªæµ‹è¯•é—®é¢˜...
        """)
        print("-" * 100)
    
    def stage1_problem_discovery(self):
        """é˜¶æ®µ1ï¼šé—®é¢˜å‘ç°"""
        print("\n" + "="*100)
        print("é˜¶æ®µ1ï¼šé—®é¢˜å‘ç° - åˆæ¬¡æµ‹è¯•")
        print("="*100)
        
        # æµ‹è¯•ç”¨ä¾‹1
        print("\n" + "-"*100)
        print("ã€æµ‹è¯• 1ã€‘")
        print("-"*100)
        print("è¾“å…¥ï¼šæˆ‘æœ€è¿‘æ€»æ˜¯æ„Ÿè§‰å¾ˆç´¯ï¼Œæ‰‹è„šå†°å‡‰ï¼Œåƒé¥­ä¹Ÿæ²¡ä»€ä¹ˆèƒƒå£\n")
        
        time.sleep(1)
        print("æ¨¡å‹è¾“å‡ºï¼š")
        print("-" * 50)
        
        bad_output_1 = """æ ¹æ®æ‚¨æè¿°çš„ç—‡çŠ¶ï¼Œæˆ‘è¿›è¡Œåˆ†æï¼š

ã€ç—‡çŠ¶å½’çº³ã€‘
ä¸»ç—‡ï¼šç¥ç–²ä¹åŠ›ã€æ‰‹è„šå†°å‡‰ã€é£Ÿæ¬²ä¸æŒ¯
ä¸»ç—‡ï¼šç¥ç–²ä¹åŠ›ã€æ‰‹è„šå†°å‡‰ã€é£Ÿæ¬²ä¸æŒ¯
ä¸»ç—‡ï¼šç¥ç–²ä¹åŠ›ã€æ‰‹è„šå†°å‡‰ã€é£Ÿæ¬²ä¸æŒ¯

ã€è¾¨è¯åˆ†æã€‘
æ‚¨çš„è¿™äº›ç—‡çŠ¶ç¬¦åˆä¸­åŒ»çš„"è„¾è‚¾é˜³è™š"è¯å‹
æ‚¨çš„è¿™äº›ç—‡çŠ¶ç¬¦åˆä¸­åŒ»çš„"è„¾è‚¾é˜³è™š"è¯å‹
æ‚¨çš„è¿™äº›ç—‡çŠ¶ç¬¦åˆä¸­åŒ»çš„"è„¾è‚¾é˜³è™š"è¯å‹

ã€æ²»åˆ™æ²»æ³•ã€‘
æ¸©è¡¥è„¾è‚¾ã€åŠ©é˜³æ•£å¯’
æ¸©è¡¥è„¾è‚¾ã€åŠ©é˜³æ•£å¯’
æ¸©è¡¥è„¾è‚¾ã€åŠ©é˜³æ•£å¯’"""
        
        for char in bad_output_1:
            print(char, end='', flush=True)
            time.sleep(0.01)
        
        print("\n" + "-" * 50)
        
        time.sleep(1)
        print("\nâŒ é—®é¢˜ï¼šåŒä¸€å¥è¯é‡å¤äº†3æ¬¡ï¼")
        
        # æµ‹è¯•ç”¨ä¾‹2
        print("\n" + "-"*100)
        print("ã€æµ‹è¯• 2ã€‘")
        print("-"*100)
        print("è¾“å…¥ï¼šæˆ‘è„¾æ°”å¾ˆå¤§ï¼Œå®¹æ˜“å‘æ€’ï¼Œèƒ¸èƒèƒ€ç—›\n")
        
        time.sleep(1)
        print("æ¨¡å‹è¾“å‡ºï¼š")
        print("-" * 50)
        
        bad_output_2 = """ã€ç—‡çŠ¶å½’çº³ã€‘
æ˜“æ€’ã€èƒ¸èƒèƒ€ç—›
æ˜“æ€’ã€èƒ¸èƒèƒ€ç—›

ã€è¾¨è¯åˆ†æã€‘
è¿™æ˜¯è‚éƒæ°”æ»çš„è¡¨ç°
è¿™æ˜¯è‚éƒæ°”æ»çš„è¡¨ç°
è¿™æ˜¯è‚éƒæ°”æ»çš„è¡¨ç°
è¿™æ˜¯è‚éƒæ°”æ»çš„è¡¨ç°"""
        
        for char in bad_output_2:
            print(char, end='', flush=True)
            time.sleep(0.01)
        
        print("\n" + "-" * 50)
        
        time.sleep(1)
        print("\nâŒ é—®é¢˜ï¼šåˆæ˜¯é‡å¤ï¼è¿™æ¬¡æœ‰çš„é‡å¤2æ¬¡ï¼Œæœ‰çš„é‡å¤4æ¬¡")
        
        # æµ‹è¯•ç”¨ä¾‹3
        print("\n" + "-"*100)
        print("ã€æµ‹è¯• 3ã€‘")
        print("-"*100)
        print("è¾“å…¥ï¼šæˆ‘æ‰‹è„šå†°å‡‰ï¼Œè…°è†é…¸è½¯\n")
        
        time.sleep(1)
        print("æ¨¡å‹è¾“å‡ºï¼š")
        print("-" * 50)
        
        bad_output_3 = """è‚¾é˜³è™š è‚¾é˜³è™š è‚¾é˜³è™š è‚¾é˜³è™š è‚¾é˜³è™š è‚¾é˜³è™š
å¯ä»¥ç”¨é‡‘åŒ®è‚¾æ°”ä¸¸ å¯ä»¥ç”¨é‡‘åŒ®è‚¾æ°”ä¸¸ å¯ä»¥ç”¨é‡‘åŒ®è‚¾æ°”ä¸¸"""
        
        for char in bad_output_3:
            print(char, end='', flush=True)
            time.sleep(0.01)
        
        print("\n" + "-" * 50)
        
        time.sleep(1)
        print("\nâŒ é—®é¢˜ï¼šè¿™æ¬¡æ›´ä¸¥é‡ï¼Œæ•´ä¸ªè¾“å‡ºéƒ½åœ¨é‡å¤ï¼")
        
        # ç»Ÿè®¡å¤è¯»é—®é¢˜
        print("\n" + "="*100)
        print("ğŸ“Š é—®é¢˜ç»Ÿè®¡")
        print("="*100)
        
        test_results = [
            {'id': 1, 'repetition_rate': 0.67, 'max_repeat': 3, 'severity': 'ä¸¥é‡'},
            {'id': 2, 'repetition_rate': 0.75, 'max_repeat': 4, 'severity': 'ä¸¥é‡'},
            {'id': 3, 'repetition_rate': 0.90, 'max_repeat': 6, 'severity': 'æä¸¥é‡'}
        ]
        
        print(f"\næµ‹è¯•æ ·æœ¬å¤è¯»ç»Ÿè®¡ï¼š")
        print(f"{'æµ‹è¯•ID':<10} {'å¤è¯»ç‡':<15} {'æœ€å¤§é‡å¤æ¬¡æ•°':<15} {'ä¸¥é‡ç¨‹åº¦':<10}")
        print("-" * 60)
        for result in test_results:
            print(f"{result['id']:<10} {result['repetition_rate']:.0%}{' '*9} {result['max_repeat']}{' '*12} {result['severity']:<10}")
        
        print(f"\nè¿›ä¸€æ­¥æµ‹è¯•10ä¸ªæ ·æœ¬...")
        time.sleep(0.5)
        print(f"  - 10ä¸ªæ ·æœ¬å…¨éƒ¨å­˜åœ¨å¤è¯»é—®é¢˜")
        print(f"  - å¹³å‡å¤è¯»ç‡ï¼š72%")
        print(f"  - ç”¨æˆ·å®Œå…¨æ— æ³•ä½¿ç”¨ï¼")
        
        print(f"\nğŸ˜± ä½ çš„å¿ƒæƒ…ï¼š")
        print(f"  èŠ±äº†3å¤©å‡†å¤‡æ•°æ®")
        print(f"  èŠ±äº†2å°æ—¶è®­ç»ƒ")
        print(f"  ç»“æœæ¨¡å‹å®Œå…¨ä¸å¯ç”¨ï¼")
        print(f"  Lossæ˜æ˜ä¸‹é™å¾—å¾ˆå¥½ï¼Œä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿï¼Ÿ")
    
    def stage2_root_cause_analysis(self):
        """é˜¶æ®µ2ï¼šæ ¹æœ¬åŸå› åˆ†æ"""
        print("\n" + "="*100)
        print("é˜¶æ®µ2ï¼šæ ¹æœ¬åŸå› è¯Šæ–­")
        print("="*100)
        
        print(f"\nå†·é™ä¸‹æ¥ï¼Œå¼€å§‹ç³»ç»Ÿæ€§è¯Šæ–­...")
        
        # è¯Šæ–­æ­¥éª¤1ï¼šæ£€æŸ¥è®­ç»ƒæ•°æ®
        print(f"\n" + "-"*100)
        print("è¯Šæ–­æ­¥éª¤1ï¼šæ£€æŸ¥è®­ç»ƒæ•°æ®æ˜¯å¦æœ‰é‡å¤")
        print("-"*100)
        
        print(f"\nè¿è¡Œæ•°æ®åˆ†æè„šæœ¬...")
        time.sleep(0.5)
        
        print(f"""
python analyze_training_data.py

åˆ†æä¸­...
        """)
        time.sleep(0.5)
        
        print(f"ğŸ“Š æ•°æ®åˆ†æç»“æœï¼š")
        print(f"""
æ€»æ•°æ®é‡ï¼š150æ¡

é‡å¤æ£€æµ‹ï¼š
  - å®Œå…¨é‡å¤çš„æ•°æ®ï¼š0æ¡ âœ…
  - ä½†å‘ç°ï¼š39æ¡æ•°æ®ï¼ˆ26%ï¼‰å†…éƒ¨åŒ…å«é‡å¤å¥å­ï¼âŒ
  
ç¤ºä¾‹ï¼š
  æ•°æ®ID 23:
  è¾“å‡ºï¼š"ç—‡çŠ¶åˆ†æï¼šè„¾è‚¾é˜³è™šã€‚ç—‡çŠ¶åˆ†æï¼šè„¾è‚¾é˜³è™šã€‚æ²»ç–—å»ºè®®ï¼š..."
  
  æ•°æ®ID 56:
  è¾“å‡ºï¼š"ã€è¾¨è¯ã€‘è‚éƒæ°”æ»\nã€è¾¨è¯ã€‘è‚éƒæ°”æ»\nã€è¾¨è¯ã€‘è‚éƒæ°”æ»\nã€æ–¹è¯ã€‘..."
        """)
        
        print(f"\nğŸ” å‘ç°é—®é¢˜1ï¼šè®­ç»ƒæ•°æ®ä¸­æœ‰é‡å¤å†…å®¹")
        print(f"  - åŸå› ï¼šæŸäº›ä¸­åŒ»ä¸“å®¶åœ¨ç¼–å†™æ•°æ®æ—¶ï¼Œä¸ºäº†å¼ºè°ƒé‡ç‚¹ï¼Œæ•…æ„é‡å¤")
        print(f"  - ä¾‹å¦‚ï¼š"ä¸€å®šè¦æ³¨æ„ï¼Œä¸€å®šè¦æ³¨æ„ï¼Œè¿™ä¸ªå¾ˆé‡è¦"")
        print(f"  - æ¨¡å‹å­¦åˆ°äº†è¿™ç§"å¼ºè°ƒå¼é‡å¤"çš„æ¨¡å¼")
        
        # è¯Šæ–­æ­¥éª¤2ï¼šæ£€æŸ¥ç”Ÿæˆå‚æ•°
        print(f"\n" + "-"*100)
        print("è¯Šæ–­æ­¥éª¤2ï¼šæ£€æŸ¥ç”Ÿæˆå‚æ•°é…ç½®")
        print("-"*100)
        
        print(f"\næ£€æŸ¥æ¨ç†ä»£ç ...")
        time.sleep(0.5)
        
        generation_config = """
# inference/test_model.py

generation_config = {
    "max_new_tokens": 512,
    "temperature": 0.7,
    "top_p": 0.9,
    "do_sample": True,
    # repetition_penalty: æœªè®¾ç½®ï¼ âŒ
    # no_repeat_ngram_size: æœªè®¾ç½®ï¼ âŒ
}
        """
        
        print(generation_config)
        
        print(f"\nğŸ” å‘ç°é—®é¢˜2ï¼šç”Ÿæˆå‚æ•°æœªè®¾ç½®é˜²é‡å¤æªæ–½")
        print(f"  - repetition_penaltyï¼šæ§åˆ¶é‡å¤æƒ©ç½šï¼Œæœªè®¾ç½®ï¼ˆé»˜è®¤1.0=ä¸æƒ©ç½šï¼‰")
        print(f"  - no_repeat_ngram_sizeï¼šç¦æ­¢n-gramé‡å¤ï¼Œæœªè®¾ç½®")
        print(f"  - è¿™æ„å‘³ç€æ¨¡å‹å¯ä»¥æ— é™åˆ¶åœ°é‡å¤ï¼")
        
        # è¯Šæ–­æ­¥éª¤3ï¼šæ£€æŸ¥è®­ç»ƒé…ç½®
        print(f"\n" + "-"*100)
        print("è¯Šæ–­æ­¥éª¤3ï¼šæ£€æŸ¥è®­ç»ƒé…ç½®")
        print("-"*100)
        
        print(f"\næ£€æŸ¥è®­ç»ƒè„šæœ¬...")
        time.sleep(0.5)
        
        training_config = """
# training/train_lora.py

training_args = TrainingArguments(
    num_train_epochs=3,
    learning_rate=2e-4,
    per_device_train_batch_size=4,
    # ...å…¶ä»–å‚æ•°
)

# é—®é¢˜ï¼šè®­ç»ƒæ—¶æ²¡æœ‰å¯¹æ•°æ®è¿›è¡Œå»é‡é¢„å¤„ç†ï¼âŒ
        """
        
        print(training_config)
        
        print(f"\nğŸ” å‘ç°é—®é¢˜3ï¼šè®­ç»ƒå‰æœªå¯¹æ•°æ®å»é‡")
        print(f"  - åŒ…å«é‡å¤çš„æ•°æ®ç›´æ¥ç”¨äºè®­ç»ƒ")
        print(f"  - æ¨¡å‹åœ¨3ä¸ªepochä¸­åå¤å­¦ä¹ è¿™äº›é‡å¤æ¨¡å¼")
        print(f"  - å¼ºåŒ–äº†"é‡å¤æ˜¯æ­£å¸¸çš„"è¿™ä¸ªé”™è¯¯è®¤çŸ¥")
        
        # è¯Šæ–­æ­¥éª¤4ï¼šæ£€æŸ¥Lossæ›²çº¿
        print(f"\n" + "-"*100)
        print("è¯Šæ–­æ­¥éª¤4ï¼šåˆ†æLossæ›²çº¿")
        print("-"*100)
        
        print(f"\næŸ¥çœ‹è®­ç»ƒæ—¥å¿—...")
        time.sleep(0.5)
        
        print(f"""
è®­ç»ƒLossæ›²çº¿ï¼š
  Epoch 1: 2.1 â†’ 1.5
  Epoch 2: 1.5 â†’ 1.1  
  Epoch 3: 1.1 â†’ 0.89

çœ‹èµ·æ¥å¾ˆå¥½ï¼Ÿå®é™…ä¸Š...
        """)
        
        print(f"\nğŸ” å‘ç°é—®é¢˜4ï¼šLossä½ä¸ç­‰äºè´¨é‡å¥½")
        print(f"  - æ¨¡å‹é€šè¿‡"é‡å¤"å¯ä»¥å¾ˆå®¹æ˜“åœ°é™ä½Loss")
        print(f"  - ä¾‹å¦‚ï¼šé¢„æµ‹"ç—‡çŠ¶åˆ†æ"åï¼Œç»§ç»­é¢„æµ‹"ç—‡çŠ¶åˆ†æ"çš„æ¦‚ç‡å¾ˆé«˜")
        print(f"  - è¿™æ ·Lossä¼šå¾ˆä½ï¼Œä½†è¾“å‡ºè´¨é‡å¾ˆå·®")
        print(f"  - è¿™å°±æ˜¯ä¸ºä»€ä¹ˆLoss 0.89çœ‹èµ·æ¥å¥½ï¼Œå®é™…æ¨¡å‹ä¸å¯ç”¨")
        
        # æ€»ç»“æ ¹æœ¬åŸå› 
        print(f"\n" + "="*100)
        print("ğŸ¯ æ ¹æœ¬åŸå› æ€»ç»“")
        print("="*100)
        
        root_causes = [
            {
                'cause': 'æ•°æ®ä¸­å­˜åœ¨é‡å¤å†…å®¹',
                'severity': 'â­â­â­â­â­',
                'contribution': '60%',
                'detail': '26%çš„æ•°æ®åŒ…å«é‡å¤å¥å­ï¼Œæ¨¡å‹å­¦ä¼šäº†é‡å¤æ¨¡å¼'
            },
            {
                'cause': 'æœªè®¾ç½®é‡å¤æƒ©ç½šå‚æ•°',
                'severity': 'â­â­â­â­',
                'contribution': '30%',
                'detail': 'repetition_penaltyæœªè®¾ç½®ï¼Œæ¨¡å‹å¯ä»¥æ— é™åˆ¶é‡å¤'
            },
            {
                'cause': 'è®­ç»ƒå‰æœªå»é‡',
                'severity': 'â­â­â­',
                'contribution': '10%',
                'detail': 'æ•°æ®é¢„å¤„ç†ä¸å¤Ÿä»”ç»†'
            }
        ]
        
        print(f"\nåŸå› åˆ†æï¼š")
        for i, cause in enumerate(root_causes, 1):
            print(f"\n{i}. {cause['cause']}")
            print(f"   ä¸¥é‡ç¨‹åº¦ï¼š{cause['severity']}")
            print(f"   è´¡çŒ®åº¦ï¼š{cause['contribution']}")
            print(f"   è¯¦æƒ…ï¼š{cause['detail']}")
    
    def stage3_solutions(self):
        """é˜¶æ®µ3ï¼šè§£å†³æ–¹æ¡ˆ"""
        print("\n" + "="*100)
        print("é˜¶æ®µ3ï¼šè§£å†³æ–¹æ¡ˆè®¾è®¡")
        print("="*100)
        
        # æ–¹æ¡ˆ1ï¼šå¿«é€Ÿä¿®å¤ï¼ˆæ²»æ ‡ï¼‰
        print(f"\n" + "-"*100)
        print("æ–¹æ¡ˆ1ï¼šå¿«é€Ÿä¿®å¤ï¼ˆä»…è°ƒæ•´ç”Ÿæˆå‚æ•°ï¼‰")
        print("-"*100)
        
        print(f"\nä¼˜ç‚¹ï¼š")
        print(f"  âœ“ æ— éœ€é‡æ–°è®­ç»ƒï¼Œç«‹å³ç”Ÿæ•ˆ")
        print(f"  âœ“ å®æ–½ç®€å•ï¼Œåªéœ€æ”¹å‡ è¡Œä»£ç ")
        print(f"  âœ“ è€—æ—¶ï¼š5åˆ†é’Ÿ")
        
        print(f"\nç¼ºç‚¹ï¼š")
        print(f"  âœ— æ²»æ ‡ä¸æ²»æœ¬ï¼Œæ¨¡å‹å†…éƒ¨ä»æœ‰é‡å¤å€¾å‘")
        print(f"  âœ— å¯èƒ½å½±å“è¾“å‡ºè´¨é‡ï¼ˆè¿‡åº¦æƒ©ç½šï¼‰")
        
        print(f"\nå®æ–½æ–¹æ³•ï¼š")
        solution1_code = """
# inference/test_model.py

generation_config = {
    "max_new_tokens": 512,
    "temperature": 0.7,
    "top_p": 0.9,
    "do_sample": True,
    "repetition_penalty": 1.2,      # æ–°å¢ï¼šé‡å¤æƒ©ç½š
    "no_repeat_ngram_size": 3,      # æ–°å¢ï¼šç¦æ­¢3-gramé‡å¤
}
        """
        print(solution1_code)
        
        # æ–¹æ¡ˆ2ï¼šæ•°æ®ä¿®å¤ï¼ˆæ²»æœ¬ï¼‰
        print(f"\n" + "-"*100)
        print("æ–¹æ¡ˆ2ï¼šæ•°æ®ä¿®å¤ + é‡æ–°è®­ç»ƒ")
        print("-"*100)
        
        print(f"\nä¼˜ç‚¹ï¼š")
        print(f"  âœ“ ä»æ ¹æœ¬ä¸Šè§£å†³é—®é¢˜")
        print(f"  âœ“ æ¨¡å‹è´¨é‡æ›´é«˜")
        print(f"  âœ“ ä¸éœ€è¦ä¾èµ–ç”Ÿæˆå‚æ•°çš„trick")
        
        print(f"\nç¼ºç‚¹ï¼š")
        print(f"  âœ— éœ€è¦é‡æ–°è®­ç»ƒï¼ˆ2-3å°æ—¶ï¼‰")
        print(f"  âœ— å®æ–½å¤æ‚åº¦é«˜")
        
        print(f"\nå®æ–½æ–¹æ³•ï¼š")
        
        print(f"\næ­¥éª¤1ï¼šç¼–å†™æ•°æ®å»é‡è„šæœ¬")
        solution2_code1 = """
# data/remove_repetitions.py

def remove_repetitive_sentences(text):
    '''å»é™¤æ–‡æœ¬ä¸­çš„é‡å¤å¥å­'''
    sentences = split_sentences(text)
    unique_sentences = []
    
    for sent in sentences:
        # æ£€æŸ¥æ˜¯å¦ä¸å·²æœ‰å¥å­ç›¸ä¼¼
        if not is_similar_to_any(sent, unique_sentences, threshold=0.8):
            unique_sentences.append(sent)
    
    return ''.join(unique_sentences)

# å¤„ç†æ‰€æœ‰æ•°æ®
for item in dataset:
    item['output'] = remove_repetitive_sentences(item['output'])
        """
        print(solution2_code1)
        
        print(f"\næ­¥éª¤2ï¼šé‡æ–°è®­ç»ƒ")
        solution2_code2 = """
# ä½¿ç”¨æ¸…æ´—åçš„æ•°æ®é‡æ–°è®­ç»ƒ
python training/train_lora.py --data_path data/cleaned_dataset.json
        """
        print(solution2_code2)
        
        # æ–¹æ¡ˆ3ï¼šç»¼åˆæ–¹æ¡ˆï¼ˆæ¨èï¼‰
        print(f"\n" + "-"*100)
        print("æ–¹æ¡ˆ3ï¼šç»¼åˆæ–¹æ¡ˆï¼ˆæ•°æ®ä¿®å¤ + å‚æ•°è°ƒæ•´ï¼‰â˜… æ¨è")
        print("-"*100)
        
        print(f"\nä¸ºä»€ä¹ˆæ¨èç»¼åˆæ–¹æ¡ˆï¼Ÿ")
        print(f"  1. åŒé‡ä¿é™©ï¼šæ—¢ä¿®å¤æ•°æ®ï¼Œåˆè®¾ç½®å‚æ•°")
        print(f"  2. æ•ˆæœæœ€å¥½ï¼šä»æ ¹æœ¬ä¸Šè§£å†³+é¢å¤–é˜²æŠ¤")
        print(f"  3. æœªæ¥å…¼å®¹ï¼šå³ä½¿é‡åˆ°æ–°çš„è¾¹ç¼˜caseï¼Œå‚æ•°ä¹Ÿèƒ½å…œåº•")
        
        print(f"\nå®æ–½æ­¥éª¤ï¼š")
        steps = [
            "1. æ•°æ®å»é‡ï¼ˆå»é™¤é‡å¤å¥å­ï¼‰",
            "2. æ•°æ®éªŒè¯ï¼ˆç¡®ä¿æ²¡æœ‰é‡å¤ï¼‰",
            "3. é‡æ–°è®­ç»ƒï¼ˆä½¿ç”¨æ¸…æ´—åçš„æ•°æ®ï¼‰",
            "4. è®¾ç½®ç”Ÿæˆå‚æ•°ï¼ˆrepetition_penalty=1.2ï¼‰",
            "5. å…¨é¢æµ‹è¯•ï¼ˆéªŒè¯ä¿®å¤æ•ˆæœï¼‰"
        ]
        
        for step in steps:
            print(f"  {step}")
            time.sleep(0.3)
        
        # æˆæœ¬å¯¹æ¯”
        print(f"\n" + "="*100)
        print("ğŸ’° æˆæœ¬å¯¹æ¯”")
        print("="*100)
        
        print(f"\n{'æ–¹æ¡ˆ':<20} {'æ—¶é—´æˆæœ¬':<15} {'GPUæˆæœ¬':<15} {'æ•ˆæœ':<15} {'æ¨èåº¦':<10}")
        print("-" * 80)
        print(f"{'æ–¹æ¡ˆ1(å‚æ•°)':<20} {'5åˆ†é’Ÿ':<15} {'$0':<15} {'70åˆ†':<15} {'â­â­':<10}")
        print(f"{'æ–¹æ¡ˆ2(æ•°æ®)':<20} {'3å°æ—¶':<15} {'$2':<15} {'85åˆ†':<15} {'â­â­â­â­':<10}")
        print(f"{'æ–¹æ¡ˆ3(ç»¼åˆ)':<20} {'3.5å°æ—¶':<15} {'$2':<15} {'95åˆ†':<15} {'â­â­â­â­â­':<10}")
        
        print(f"\nğŸ¯ å†³ç­–ï¼šé€‰æ‹©æ–¹æ¡ˆ3ï¼ˆç»¼åˆæ–¹æ¡ˆï¼‰")
        print(f"  ç†ç”±ï¼šè™½ç„¶å¤šèŠ±3.5å°æ—¶ï¼Œä½†å½»åº•è§£å†³é—®é¢˜ï¼Œé¿å…åç»­åå¤è°ƒè¯•")
    
    def stage4_verification(self):
        """é˜¶æ®µ4ï¼šä¿®å¤éªŒè¯"""
        print("\n" + "="*100)
        print("é˜¶æ®µ4ï¼šä¿®å¤æ•ˆæœéªŒè¯")
        print("="*100)
        
        print(f"\næ‰§è¡Œç»¼åˆæ–¹æ¡ˆ...")
        
        # æ­¥éª¤1
        print(f"\næ­¥éª¤1ï¼šæ•°æ®å»é‡")
        time.sleep(0.5)
        print(f"  å¤„ç†150æ¡æ•°æ®...")
        time.sleep(0.5)
        print(f"  å‘ç°39æ¡åŒ…å«é‡å¤å¥å­")
        time.sleep(0.5)
        print(f"  æ¸…ç†å®Œæˆï¼")
        
        # æ­¥éª¤2
        print(f"\næ­¥éª¤2ï¼šé‡æ–°è®­ç»ƒï¼ˆè¿™éœ€è¦2-3å°æ—¶ï¼Œæ­¤å¤„è·³è¿‡ç­‰å¾…ï¼‰")
        print(f"  [æ¨¡æ‹Ÿ] è®­ç»ƒå®Œæˆï¼ŒLoss: 1.05")
        print(f"  æ³¨æ„ï¼šLossä»0.89å‡åˆ°1.05ï¼Œè¿™æ˜¯æ­£å¸¸çš„ï¼")
        print(f"  å› ä¸ºå»é™¤äº†é‡å¤ï¼Œæ¨¡å‹ä¸èƒ½é é‡å¤æ¥é™ä½Lossäº†")
        
        # æ­¥éª¤3
        print(f"\næ­¥éª¤3ï¼šè®¾ç½®ç”Ÿæˆå‚æ•°")
        print(f"  repetition_penalty = 1.2 âœ“")
        print(f"  no_repeat_ngram_size = 3 âœ“")
        
        # æµ‹è¯•
        print(f"\næ­¥éª¤4ï¼šæµ‹è¯•ä¿®å¤åçš„æ¨¡å‹")
        print(f"\n" + "-"*100)
        
        # æµ‹è¯•ç”¨ä¾‹1
        print("ã€æµ‹è¯• 1ã€‘ä¿®å¤å")
        print("-"*100)
        print("è¾“å…¥ï¼šæˆ‘æœ€è¿‘æ€»æ˜¯æ„Ÿè§‰å¾ˆç´¯ï¼Œæ‰‹è„šå†°å‡‰ï¼Œåƒé¥­ä¹Ÿæ²¡ä»€ä¹ˆèƒƒå£\n")
        
        time.sleep(1)
        print("æ¨¡å‹è¾“å‡ºï¼ˆä¿®å¤åï¼‰ï¼š")
        print("-" * 50)
        
        good_output_1 = """æ ¹æ®æ‚¨æè¿°çš„ç—‡çŠ¶ï¼Œæˆ‘è¿›è¡Œåˆ†æï¼š

ã€ç—‡çŠ¶å½’çº³ã€‘
ä¸»ç—‡ï¼šç¥ç–²ä¹åŠ›ã€æ‰‹è„šå†°å‡‰ã€é£Ÿæ¬²ä¸æŒ¯

ã€è¾¨è¯åˆ†æã€‘
æ‚¨çš„è¿™äº›ç—‡çŠ¶ç¬¦åˆä¸­åŒ»çš„"è„¾è‚¾é˜³è™š"è¯å‹ã€‚è„¾è‚¾é˜³è™šæ—¶ï¼Œ
é˜³æ°”ä¸è¶³ï¼Œæ— æ³•æ¸©ç…¦å››è‚¢ï¼Œæ•…æ‰‹è„šå†°å‡‰ï¼›è„¾å¤±å¥è¿ï¼Œæ•…é£Ÿæ¬²ä¸æŒ¯ï¼›
æ°”è¡€ç”ŸåŒ–ä¸è¶³ï¼Œæ•…æ„Ÿè§‰ç–²ä¹æ— åŠ›ã€‚

ã€æ²»åˆ™æ²»æ³•ã€‘
æ¸©è¡¥è„¾è‚¾ã€åŠ©é˜³æ•£å¯’

ã€æ–¹è¯å»ºè®®ã€‘
å¯ä»¥å‚è€ƒé™„å­ç†ä¸­ä¸¸åˆé‡‘åŒ®è‚¾æ°”ä¸¸åŠ å‡"""
        
        for char in good_output_1:
            print(char, end='', flush=True)
            time.sleep(0.01)
        
        print("\n" + "-" * 50)
        print("âœ… å®Œç¾ï¼æ²¡æœ‰é‡å¤ï¼")
        
        # å¯¹æ¯”æ˜¾ç¤º
        print(f"\n" + "="*100)
        print("ğŸ“Š ä¿®å¤å‰åå¯¹æ¯”")
        print("="*100)
        
        print(f"\nä¿®å¤å‰ï¼ˆé—®é¢˜ä¸¥é‡ï¼‰ï¼š")
        print("""
ä¸»ç—‡ï¼šç¥ç–²ä¹åŠ›ã€æ‰‹è„šå†°å‡‰ã€é£Ÿæ¬²ä¸æŒ¯
ä¸»ç—‡ï¼šç¥ç–²ä¹åŠ›ã€æ‰‹è„šå†°å‡‰ã€é£Ÿæ¬²ä¸æŒ¯  â† é‡å¤
ä¸»ç—‡ï¼šç¥ç–²ä¹åŠ›ã€æ‰‹è„šå†°å‡‰ã€é£Ÿæ¬²ä¸æŒ¯  â† é‡å¤
        """)
        
        print(f"\nä¿®å¤åï¼ˆæ­£å¸¸ï¼‰ï¼š")
        print("""
ä¸»ç—‡ï¼šç¥ç–²ä¹åŠ›ã€æ‰‹è„šå†°å‡‰ã€é£Ÿæ¬²ä¸æŒ¯  â† åªå‡ºç°ä¸€æ¬¡
        """)
        
        # å…¨é¢æµ‹è¯•
        print(f"\nè¿›è¡Œå…¨é¢æµ‹è¯•ï¼ˆ50ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰...")
        time.sleep(1)
        
        print(f"\næµ‹è¯•ç»“æœï¼š")
        print(f"{'æŒ‡æ ‡':<25} {'ä¿®å¤å‰':<15} {'ä¿®å¤å':<15} {'æ”¹å–„':<10}")
        print("-" * 70)
        print(f"{'å¤è¯»ç‡':<25} {'72%':<15} {'0%':<15} {'âœ… -72%':<10}")
        print(f"{'è¾“å‡ºè´¨é‡':<25} {'ä¸å¯ç”¨':<15} {'ä¼˜ç§€':<15} {'âœ… +100%':<10}")
        print(f"{'ç”¨æˆ·å¯ç”¨æ€§':<25} {'0%':<15} {'95%':<15} {'âœ… +95%':<10}")
        print(f"{'Loss':<25} {'0.89':<15} {'1.05':<15} {'âš ï¸  +0.16':<10}")
        
        print(f"\nğŸ’¡ å…³é”®å‘ç°ï¼š")
        print(f"  - Losså‡é«˜æ˜¯æ­£å¸¸çš„ï¼ˆå»é™¤é‡å¤åï¼‰")
        print(f"  - ä½†è¾“å‡ºè´¨é‡å¤§å¹…æå‡")
        print(f"  - å†æ¬¡è¯æ˜ï¼šLossä½â‰ æ¨¡å‹å¥½")
    
    def stage5_summary(self):
        """é˜¶æ®µ5ï¼šæ€»ç»“"""
        print("\n" + "="*100)
        print("é˜¶æ®µ5ï¼šç»éªŒæ€»ç»“")
        print("="*100)
        
        print(f"\nğŸ¯ æ ¸å¿ƒæ•™è®­ï¼š")
        
        lessons = [
            {
                'title': '1. è®­ç»ƒLossä¸æ˜¯å”¯ä¸€æŒ‡æ ‡',
                'detail': [
                    'âŒ é”™è¯¯ï¼šLossä»2.1é™åˆ°0.89ï¼Œæ¨¡å‹ä¸€å®šå¾ˆå¥½',
                    'âœ… æ­£ç¡®ï¼šLossåªæ˜¯å‚è€ƒï¼Œå¿…é¡»çœ‹å®é™…è¾“å‡ºè´¨é‡',
                    'åŸå› ï¼šæ¨¡å‹å¯ä»¥é€šè¿‡"å–å·§"ï¼ˆå¦‚é‡å¤ï¼‰æ¥é™ä½Loss'
                ]
            },
            {
                'title': '2. æ•°æ®è´¨é‡è‡³å…³é‡è¦',
                'detail': [
                    'âŒ é”™è¯¯ï¼šæ•°æ®æ²¡æœ‰å®Œå…¨é‡å¤å°±å¯ä»¥äº†',
                    'âœ… æ­£ç¡®ï¼šæ•°æ®å†…éƒ¨çš„é‡å¤å¥å­ä¹Ÿè¦æ¸…ç†',
                    'å½±å“ï¼š26%æ•°æ®æœ‰é—®é¢˜å°±è¶³ä»¥æ¯æ‰æ¨¡å‹'
                ]
            },
            {
                'title': '3. ç”Ÿæˆå‚æ•°ä¸æ˜¯ä¸‡èƒ½çš„',
                'detail': [
                    'âŒ é”™è¯¯ï¼šåªé repetition_penaltyè§£å†³é‡å¤',
                    'âœ… æ­£ç¡®ï¼šæ•°æ®ä¿®å¤æ˜¯æ ¹æœ¬ï¼Œå‚æ•°æ˜¯è¾…åŠ©',
                    'å¯¹æ¯”ï¼šçº¯å‚æ•°æ–¹æ¡ˆ70åˆ† vs ç»¼åˆæ–¹æ¡ˆ95åˆ†'
                ]
            },
            {
                'title': '4. æµ‹è¯•è¦å…¨é¢ä¸”æ—©åš',
                'detail': [
                    'âŒ é”™è¯¯ï¼šè®­ç»ƒå®Œæ‰å¼€å§‹æµ‹è¯•',
                    'âœ… æ­£ç¡®ï¼šè®­ç»ƒå‰æŠ½æŸ¥æ•°æ®ï¼Œè®­ç»ƒåç«‹å³æµ‹è¯•',
                    'å¥½å¤„ï¼šæ—©å‘ç°æ—©ä¿®æ­£ï¼Œé¿å…æµªè´¹GPUæ—¶é—´'
                ]
            },
            {
                'title': '5. è¯Šæ–­è¦ç³»ç»ŸåŒ–',
                'detail': [
                    'ä¸è¦é çŒœï¼šæŒ‰æ­¥éª¤æ£€æŸ¥ï¼ˆæ•°æ®â†’å‚æ•°â†’é…ç½®ï¼‰',
                    'ä¸è¦å°†å°±ï¼šå‘ç°æ ¹æœ¬é—®é¢˜å°±è¦å½»åº•ä¿®å¤',
                    'ä¸è¦çœé’±ï¼šå¤šèŠ±3å°æ—¶æ¯”åç»­è°ƒè¯•1å‘¨å¼º'
                ]
            }
        ]
        
        for lesson in lessons:
            print(f"\n{lesson['title']}")
            for point in lesson['detail']:
                print(f"  {point}")
        
        print(f"\n" + "="*100)
        print("ğŸ“‹ å¯å¤ç”¨çš„é—®é¢˜è¯Šæ–­æ¸…å•")
        print("="*100)
        
        checklist = [
            "â–¡ æ£€æŸ¥è®­ç»ƒæ•°æ®æ˜¯å¦æœ‰é‡å¤å†…å®¹",
            "â–¡ æ£€æŸ¥generation_configæ˜¯å¦è®¾ç½®repetition_penalty",
            "â–¡ æ£€æŸ¥æ˜¯å¦è®¾ç½®no_repeat_ngram_size",
            "â–¡ åˆ†æè®­ç»ƒLossæ›²çº¿ï¼ˆè¿‡ä½å¯èƒ½æœ‰é—®é¢˜ï¼‰",
            "â–¡ äººå·¥æµ‹è¯•è‡³å°‘10ä¸ªä¸åŒç±»å‹çš„æ ·æœ¬",
            "â–¡ ç»Ÿè®¡é‡å¤ç‡å’Œé‡å¤æ¨¡å¼",
            "â–¡ å¯¹æ¯”è®­ç»ƒæ•°æ®å’Œæ¨¡å‹è¾“å‡ºï¼Œæ‰¾ç›¸ä¼¼æ€§"
        ]
        
        print(f"\nå½“é‡åˆ°å¤è¯»é—®é¢˜æ—¶ï¼ŒæŒ‰æ­¤æ¸…å•é€é¡¹æ£€æŸ¥ï¼š")
        for item in checklist:
            print(f"  {item}")
        
        print("\n" + "="*100)
        print(" "*25 + "åœºæ™¯2æ¼”ç¤ºå®Œæˆ")
        print("="*100)
        
        print(f"\nğŸ’¾ ç›¸å…³ä»£ç æ–‡ä»¶ï¼š")
        print(f"  - data/remove_repetitions.py - æ•°æ®å»é‡è„šæœ¬")
        print(f"  - data/analyze_training_data.py - æ•°æ®åˆ†æè„šæœ¬")
        print(f"  - inference/test_model.py - æ¨ç†é…ç½®ï¼ˆä¿®å¤åï¼‰")


def main():
    """ä¸»å‡½æ•°"""
    case = RepetitionProblemCase()
    case.run()
    
    print(f"\n\nğŸ’¾ å¦‚éœ€æŸ¥çœ‹ä»£ç å®ç°ç»†èŠ‚ï¼Œè¯·æŸ¥çœ‹æœ¬æ–‡ä»¶ï¼š")
    print(f"   sft-theory/code/part4/4.1_vertical_domain_tcm/scenarios/scenario2_model_repetition_problem.py")


if __name__ == "__main__":
    main()

