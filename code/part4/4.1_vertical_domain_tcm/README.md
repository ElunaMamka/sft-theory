# 4.1 垂直领域SFT实践：中医问诊助手

## 📋 项目概述

这是一个**真实的、完整的**垂直领域SFT项目，不仅包含训练代码，更重要的是展示了：
- ✅ **真实的数据筛选迭代过程**（5轮筛选，多次回溯）
- ✅ **真实的模型问题诊断**（复读、知识缺失、格式不一致等5大问题）
- ✅ **真实的调试修复流程**（从v0.1完全失败到v1.1效果优秀）
- ✅ **完整的迭代记录**（7天开发过程的详细记录）

> 💡 **这不是理想化的教程，而是真实项目会遇到的问题和解决方案！**

## 🎯 项目目标

- **领域专业化**：让通用模型掌握中医术语、诊断逻辑和治疗建议
- **对话能力**：能够进行多轮问诊对话，询问症状、舌象、脉象等
- **安全可控**：给出合理建议，避免危险诊断
- **真实场景**：展示完整的SFT迭代过程，包括失败和修复

## 📊 数据特点

- **真实长对话**：完整的中医问诊流程，包含望闻问切
- **专业术语**：阴阳五行、气血津液、脏腑经络等专业概念
- **结构化输出**：症状分析 → 证型判断 → 治则治法 → 方剂建议

## 🚀 快速开始

### 方式1：一键运行（推荐初学者）

```bash
bash run_full_pipeline.sh
```

### 方式2：体验真实的SFT调试过程（推荐学习）

#### 第一步：了解真实的数据筛选过程

```bash
# 运行多轮数据筛选演示
python data/data_filtering_pipeline.py
```

这个脚本会展示：
- ✅ 第1轮：基础规则筛选
- ✅ 第2轮：专业术语检查
- ✅ 第3轮：AI模型打分
- ❌ 发现问题：高分数据仍有问题！
- ✅ 第4轮：回溯修正，添加新规则
- ✅ 第5轮：人工复核

#### 第二步：训练初始模型

```bash
# 1. 准备数据
python data/raw_examples.py
python data/prepare_dataset.py

# 2. 训练模型
python training/train_lora.py
```

#### 第三步：诊断模型问题

```bash
# 运行问题诊断工具
python training/problem_diagnosis_and_fix.py
```

这个脚本会诊断5大典型问题：
1. ❌ 模型复读问题
2. ❌ 专业知识缺失
3. ❌ 输出格式不一致
4. ❌ 模型过度保守
5. ❌ 忽视用户输入

并提供详细的解决方案！

#### 第四步：查看完整迭代记录

```bash
# 阅读7天开发日志
cat ITERATION_LOG.md
```

了解从失败到成功的完整过程：
- v0.1：完全失败（所有输出都是"建议就医"）
- v0.2：严重复读（同一句话重复3次）
- v0.3：判断错误（所有症状都诊断为"脾肾阳虚"）
- v1.0：基本可用（准确率85%）
- v1.1：效果优秀（准确率92%）

### 方式3：标准流程（已经理解迭代过程）

```bash
# 1. 安装依赖
pip install -r requirements.txt

# 2. 准备数据
python data/raw_examples.py
python data/prepare_dataset.py

# 3. 训练模型
python training/train_lora.py

# 4. 测试模型
python inference/test_model.py

# 5. 交互式演示
python inference/interactive_demo.py
```

## 📁 项目结构

```
4.1_vertical_domain_tcm/
├── data/               # 数据准备
│   ├── raw_examples.py              # 真实中医问诊数据示例
│   ├── prepare_dataset.py           # 数据预处理和格式化
│   ├── dataset_analysis.py          # 数据集统计分析
│   └── data_filtering_pipeline.py   # 🔥 真实的多轮数据筛选流程
│
├── model/              # 模型配置
│   ├── model_config.py        # 模型参数配置
│   └── model_utils.py         # 模型工具函数
│
├── training/           # 训练脚本
│   ├── train_lora.py                  # LoRA微调训练
│   ├── train_distributed.py           # 分布式训练
│   ├── training_config.yaml           # 训练超参数
│   └── problem_diagnosis_and_fix.py   # 🔥 模型问题诊断与修复
│
├── inference/          # 推理测试
│   ├── test_model.py          # 模型测试脚本
│   └── interactive_demo.py    # 交互式问诊演示
│
├── ITERATION_LOG.md            # 🔥 完整的7天迭代记录
├── run_full_pipeline.sh        # 一键运行脚本
└── README.md                   # 本文档
```

### 🔥 核心亮点文件

| 文件 | 作用 | 为什么重要 |
|------|------|----------|
| `data/data_filtering_pipeline.py` | 5轮数据筛选流程 | 展示真实的数据迭代过程，包括发现问题、回溯修正 |
| `training/problem_diagnosis_and_fix.py` | 诊断5大典型问题 | 复读、知识缺失、格式不一致等真实问题的解决方案 |
| `ITERATION_LOG.md` | 7天开发日志 | 从v0.1失败到v1.1成功的完整记录，避免重复踩坑 |

## 💡 关键技术点

### 理论技术
1. **领域数据构建**：如何构建高质量的中医问诊数据
2. **专业术语处理**：中医术语的tokenization和embedding
3. **LoRA微调**：高效微调，只训练0.1%参数
4. **推理优化**：批处理、KV缓存加速

### 实战经验（更重要！）
1. **数据筛选迭代**：
   - 不是一次性筛选，而是多轮迭代
   - 发现问题后要勇于回溯重新筛选
   - AI打分不能完全替代人工审核

2. **模型问题诊断**：
   - 复读问题：检查数据去重、调整解码参数
   - 知识缺失：分析数据分布、针对性补充
   - 格式不一致：统一数据格式
   - 过度保守：平衡安全性和实用性
   - 忽视输入：数据平衡采样

3. **重训练策略**：
   - 何时从头训练 vs 继续训练
   - 如何避免重复犯错
   - 保持详细的实验记录

4. **质量控制**：
   - 宁缺毋滥：质量 > 数量
   - 专家审核不可或缺
   - 持续测试，及时发现问题

## 📈 预期效果

- **基座模型**：对中医一无所知或给出错误建议
- **微调后**：能够准确识别证型，给出合理的中医治疗建议
- **训练时间**：单卡V100约2-3小时（1000条数据）

